<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Making and Scaling a Game Server in Kubernetes using Agones &#183; /home/noe</title><meta name=title content="Making and Scaling a Game Server in Kubernetes using Agones &#183; /home/noe"><meta name=description content="Learn with me how to create a game server in Go for Agones, deploying it on Kubernetes, designing an event-based matchmaking service also in Go, and setting up autoscaling for the whole thing."><meta name=keywords content="kubernetes,go,agones,"><link rel=canonical href=https://noe-t.dev/posts/making-and-scaling-a-game-server-in-k8s-using-agones/><meta name=author content="No√© Tarbouriech"><link href=https://github.com/noetarbouriech/ rel=me><link href=https://www.linkedin.com/in/noe-tarbouriech/ rel=me><meta property="og:url" content="https://noe-t.dev/posts/making-and-scaling-a-game-server-in-k8s-using-agones/"><meta property="og:site_name" content="/home/noe"><meta property="og:title" content="Making and Scaling a Game Server in Kubernetes using Agones"><meta property="og:description" content="Learn with me how to create a game server in Go for Agones, deploying it on Kubernetes, designing an event-based matchmaking service also in Go, and setting up autoscaling for the whole thing."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-01-22T00:00:00+00:00"><meta property="article:modified_time" content="2026-01-22T00:00:00+00:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Go"><meta property="article:tag" content="Agones"><meta property="og:image" content="https://noe-t.dev/posts/making-and-scaling-a-game-server-in-k8s-using-agones/featured.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://noe-t.dev/posts/making-and-scaling-a-game-server-in-k8s-using-agones/featured.png"><meta name=twitter:title content="Making and Scaling a Game Server in Kubernetes using Agones"><meta name=twitter:description content="Learn with me how to create a game server in Go for Agones, deploying it on Kubernetes, designing an event-based matchmaking service also in Go, and setting up autoscaling for the whole thing."><link type=text/css rel=stylesheet href=/css/main.bundle.min.7a3a3d24c62bb9e05dd9d99fb87947233bf162ca218889bacbd0bacdfa3dd169c7dcae5f0df76864ac79e9cdb3a1fe99f257a9d7684357c968bc39bb95bdcf9b.css integrity="sha512-ejo9JMYrueBd2dmfuHlHIzvxYsohiIm6y9C6zfo90WnH3K5fDfdoZKx56c2zof6Z8lep12hDV8lovDm7lb3Pmw=="><script type=text/javascript src=/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.0e2e7ce1e319db5369cd4badb8265de52c78d08df54617521bdac9c8cd335eea6133a82c83f9cb19baf67b8133335130e7e8ff7cfeaf7171016648dbf5a0578a.js integrity="sha512-Di584eMZ21NpzUutuCZd5Sx40I31RhdSG9rJyM0zXuphM6gsg/nLGbr2e4EzM1Ew5+j/fP6vcXEBZkjb9aBXig==" data-copy=Copy data-copied=Copied></script><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><script defer type=text/javascript src=/js/mermaid.bundle.123b31b3c46015cee384d15cf0ef614f7ed885722a7e6f496f9b83d7b8400aef5dc2f3b9fc778649d5ba948bf957b3c67bbdf4de0033db316bbe394e2f7da794.js integrity="sha512-Ejsxs8RgFc7jhNFc8O9hT37YhXIqfm9Jb5uD17hACu9dwvO5/HeGSdW6lIv5V7PGe7303gAz2zFrvjlOL32nlA=="></script><link rel=stylesheet href=/css/repo-cards.min.baaf512416b3dfd1e3a95a3f3d8d49e978f267c0efded75be3635a9fd4655746757c1277a3a67d77c541de80b862394f6aacc26b32d3c09fb016a071661253e9.css integrity="sha512-uq9RJBaz39HjqVo/PY1J6XjyZ8Dv3tdb42Nan9RlV0Z1fBJ3o6Z9d8VB3oC4YjlPaqzCazLTwJ+wFqBxZhJT6Q=="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Making and Scaling a Game Server in Kubernetes using Agones","headline":"Making and Scaling a Game Server in Kubernetes using Agones","inLanguage":"en","url":"https://noe-t.dev/posts/making-and-scaling-a-game-server-in-k8s-using-agones/","author":{"@type":"Person","name":"No√© Tarbouriech"},"copyrightYear":"2026","dateCreated":"2026-01-22T00:00:00\u002b00:00","datePublished":"2026-01-22T00:00:00\u002b00:00","dateModified":"2026-01-22T00:00:00\u002b00:00","keywords":["kubernetes","go","agones"],"mainEntityOfPage":"true","wordCount":"5950"}]</script><script data-id=umami-script async src=https://noe-t.dev/scripts/umami-script.js data-website-id=1e524370-35e7-4b0d-9dae-b4523aac1f83 data-domains=noe-t.dev></script><script type=text/javascript>document.querySelector('script[data-id="umami-script"]').addEventListener("load",function(){const e=document.head.querySelector('meta[property = "og:type"]').getAttribute("content");let t=document.head.querySelector('meta[property = "og:title"]').getAttribute("content"),n=document.head.querySelector('meta[property = "og:url"]').getAttribute("content");umami.track(e+":"+t,{url:n})})</script></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral bf-scrollbar"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class="main-menu flex items-center w-full gap-2 p-1 pl-0"><a href=/ class="text-base font-medium truncate min-w-0 shrink">/home/noe</a><div class="flex items-center ms-auto"><div class="hidden md:flex"><nav class="flex items-center gap-x-5 h-12"><a href=/posts/ class="flex items-center bf-icon-color-hover" aria-label=posts title=Posts><span class="text-base font-medium break-normal">posts
</span></a><a href=/tags/ class="flex items-center bf-icon-color-hover" aria-label=tags title=Tags><span class="text-base font-medium break-normal">tags
</span></a><a href=/about/ class="flex items-center bf-icon-color-hover" aria-label=about title="About me"><span class="text-base font-medium break-normal">about
</span></a><a href=/sitemap.xml class="flex items-center bf-icon-color-hover" aria-label=rss title><span><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 64C0 46.3 14.3 32 32 32c229.8.0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7.0 64zM128 416c0 35.3-28.7 64-64 64S0 451.3.0 416s28.7-64 64-64 64 28.7 64 64zM32 160c159.1.0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7.0-32-14.3-32-32s14.3-32 32-32z"/></svg></span>
</span></a><button id=search-button aria-label=Search class="text-base bf-icon-color-hover" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base bf-icon-color-hover"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav></div><div class="flex md:hidden"><div class="flex items-center h-14 gap-4"><button id=search-button-mobile aria-label=Search class="flex items-center justify-center bf-icon-color-hover" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile type=button aria-label="Dark mode switcher" class="flex items-center justify-center text-neutral-900 hover:text-primary-600 dark:text-neutral-200 dark:hover:text-primary-400"><div class=dark:hidden><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="hidden dark:block"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button>
<input type=checkbox id=mobile-menu-toggle autocomplete=off class="hidden peer">
<label for=mobile-menu-toggle class="flex items-center justify-center cursor-pointer bf-icon-color-hover"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></label><div role=dialog aria-modal=true style=scrollbar-gutter:stable class="fixed inset-0 z-50 invisible overflow-y-auto px-6 py-20 opacity-0 transition-[opacity,visibility] duration-300 peer-checked:visible peer-checked:opacity-100 bg-neutral-50/97 dark:bg-neutral-900/99
bf-scrollbar"><label for=mobile-menu-toggle class="fixed end-8 top-5 flex items-center justify-center z-50 h-12 w-12 cursor-pointer select-none rounded-full bf-icon-color-hover border bf-border-color bf-border-color-hover bg-neutral-50 dark:bg-neutral-900"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></label><nav class="mx-auto max-w-md space-y-6"><div class=px-2><a href=/posts/ aria-label=posts class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Posts class="text-2xl font-bold tracking-tight">posts</span></a></div><div class=px-2><a href=/tags/ aria-label=tags class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Tags class="text-2xl font-bold tracking-tight">tags</span></a></div><div class=px-2><a href=/about/ aria-label=about class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title="About me" class="text-2xl font-bold tracking-tight">about</span></a></div><div class=px-2><a href=/sitemap.xml aria-label=rss class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span class="flex items-center justify-center h-8 w-8 text-2xl"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 64C0 46.3 14.3 32 32 32c229.8.0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7.0 64zM128 416c0 35.3-28.7 64-64 64S0 451.3.0 416s28.7-64 64-64 64 28.7 64 64zM32 160c159.1.0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7.0-32-14.3-32-32s14.3-32 32-32z"/></svg></span>
</span><span title class="text-2xl font-bold tracking-tight"></span></a></div></nav></div></div></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div id=hero class="h-[150px] md:h-[200px]"></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"><img id=background-image src=/posts/making-and-scaling-a-game-server-in-k8s-using-agones/featured_hu_e3edc8bb5310ad29.png role=presentation loading=eager decoding=async fetchpriority=high class="absolute inset-0 w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-xl bg-neutral-100/75 dark:bg-neutral-800/60"></div><script type=text/javascript src=/js/background-blur.min.605b3b942818f0ab5a717ae446135ec46b8ee5a2ad12ae56fb90dc2a76ce30c388f9fec8bcc18db15bd47e3fa8a09d779fa12aa9c184cf614a315bc72c6c163d.js integrity="sha512-YFs7lCgY8KtacXrkRhNexGuO5aKtEq5W+5DcKnbOMMOI+f7IvMGNsVvUfj+ooJ13n6EqqcGEz2FKMVvHLGwWPQ==" data-blur-id=background-blur data-image-id=background-image data-image-url=/posts/making-and-scaling-a-game-server-in-k8s-using-agones/featured_hu_e3edc8bb5310ad29.png></script><header id=single_header class="mt-5 max-w-prose"><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>/home/noe</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/making-and-scaling-a-game-server-in-k8s-using-agones/>Making and Scaling a Game Server in Kubernetes using Agones</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Making and Scaling a Game Server in Kubernetes using Agones</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2026-01-22T00:00:00+00:00>22 January 2026</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">28 mins</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/tags/kubernetes/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/go/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Go
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/agones/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Agones</span></span></a></div></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full me-4" width=96 height=96 alt="No√© Tarbouriech" src=/profile_hu_5ad3741dcc3993f6.png data-zoom-src=/profile_hu_7b0a928f31513690.png><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">No√© Tarbouriech</div><div class="text-sm text-neutral-700 dark:text-neutral-400">DevOps engineer</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/noetarbouriech/ target=_blank aria-label=Github title=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://www.linkedin.com/in/noe-tarbouriech/ target=_blank aria-label=Linkedin title=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:contact@noe-t.dev target=_blank aria-label=Email title=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ms-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs"><div class="toc ps-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain bf-scrollbar rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#why-agones>Why Agones</a></li><li><a href=#developing-a-game-server-in-go>Developing a game server in Go</a></li><li><a href=#adding-agones-to-a-game-server>Adding Agones to a game server</a></li><li><a href=#deploying-a-game-server>Deploying a game server</a></li><li><a href=#making-a-matchmaking-service>Making a matchmaking service</a></li><li><a href=#setting-up-autoscaling-of-game-servers>Setting up autoscaling of game servers</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#why-agones>Why Agones</a></li><li><a href=#developing-a-game-server-in-go>Developing a game server in Go</a></li><li><a href=#adding-agones-to-a-game-server>Adding Agones to a game server</a></li><li><a href=#deploying-a-game-server>Deploying a game server</a></li><li><a href=#making-a-matchmaking-service>Making a matchmaking service</a></li><li><a href=#setting-up-autoscaling-of-game-servers>Setting up autoscaling of game servers</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>If you&rsquo;re interested in Kubernetes like I am, you&rsquo;ve probably found yourself exploring related projects on GitHub and you might have stumbled upon a repository called <a href=https://github.com/googleforgames/agones target=_blank rel=noreferrer>Agones</a>. If you&rsquo;ve never heard about it, Agones is a project created by Google to manage and deploy video game servers on Kubernetes.</p><p>Recently, I dipped my toes in the water and tried it out. I had a lot of fun doing so and I want to share everything I learned. In this article, we will go over the following:</p><ul><li>The creation of a basic <strong>game server in Go</strong>.</li><li>Integrating it with <strong>Agones&rsquo; SDK</strong>.</li><li>Its deployment on <strong>Kubernetes with Agones</strong>.</li><li>The making of a <strong>matchmaking service in Go</strong>.</li><li>Setting up and benchmarking <strong>autoscaling</strong> for our infrastructure based on the matchmaking&rsquo;s player queue.</li></ul><p>I&rsquo;ll share a lot of relevant code snippets and diagrams, but if you want to get the full picture, you can find the source code and the Kubernetes manifests in this GitHub repository:</p><div class=github-card-wrapper><a id=github-53dcb7622c746091d03c6687258787d4 target=_blank href=https://github.com/noetarbouriech/agones-rps-game class=cursor-pointer><div class="w-full md:w-auto p-0 m-0 border border-neutral-200 dark:border-neutral-700 border rounded-md shadow-2xl"><div class="w-full nozoom"><img src=https://opengraph.githubassets.com/0/noetarbouriech/agones-rps-game alt="GitHub Repository Thumbnail" class="nozoom mt-0 mb-0 w-full h-full object-cover"></div><div class="w-full md:w-auto pt-3 p-5"><div class="flex items-center"><span class="text-2xl text-neutral-800 dark:text-neutral me-2"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span><div id=github-53dcb7622c746091d03c6687258787d4-full_name class="m-0 font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral">noetarbouriech/agones-rps-game</div></div><p id=github-53dcb7622c746091d03c6687258787d4-description class="m-0 mt-2 text-md text-neutral-800 dark:text-neutral">A rock paper scissors game in Go deployed on K8s with Agones</p><div class="m-0 mt-2 flex items-center"><span class="mr-1 inline-block h-3 w-3 rounded-full language-dot" data-language=Go></span><div class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">Go</div><span class="text-md mr-1 text-neutral-800 dark:text-neutral"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentColor" d="M287.9.0C297.1.0 305.5 5.25 309.5 13.52L378.1 154.8l153.3 22.7C540.4 178.8 547.8 185.1 550.7 193.7 553.5 202.4 551.2 211.9 544.8 218.2L433.6 328.4l26.3 155.5C461.4 492.9 457.7 502.1 450.2 507.4 442.8 512.7 432.1 513.4 424.9 509.1L287.9 435.9 150.1 509.1C142.9 513.4 133.1 512.7 125.6 507.4 118.2 502.1 114.5 492.9 115.1 483.9l27.1-155.5L31.11 218.2C24.65 211.9 22.36 202.4 25.2 193.7 28.03 185.1 35.5 178.8 44.49 177.5L197.7 154.8 266.3 13.52C270.4 5.249 278.7.0 287.9.0zm0 78.95L235.4 187.2C231.9 194.3 225.1 199.3 217.3 200.5L98.98 217.9 184.9 303C190.4 308.5 192.9 316.4 191.6 324.1L171.4 443.7l105.2-56.2C283.7 383.7 292.2 383.7 299.2 387.5l105.2 56.2-20.2-119.6C382.9 316.4 385.5 308.5 391 303l85.9-85.1-118.3-17.4C350.7 199.3 343.9 194.3 340.5 187.2L287.9 78.95z"/></svg></span></span><div id=github-53dcb7622c746091d03c6687258787d4-stargazers class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">0</div><span class="text-md mr-1 text-neutral-800 dark:text-neutral"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M80 104c13.3.0 24-10.7 24-24S93.3 56 80 56 56 66.7 56 80s10.7 24 24 24zm80-24c0 32.8-19.7 61-48 73.3V192c0 17.7 14.3 32 32 32H304c17.7.0 32-14.3 32-32V153.3C307.7 141 288 112.8 288 80c0-44.2 35.8-80 80-80s80 35.8 80 80c0 32.8-19.7 61-48 73.3V192c0 53-43 96-96 96H256v70.7c28.3 12.3 48 40.5 48 73.3.0 44.2-35.8 80-80 80s-80-35.8-80-80c0-32.8 19.7-61 48-73.3V288H144c-53 0-96-43-96-96V153.3C19.7 141 0 112.8.0 80 0 35.8 35.8.0 80 0s80 35.8 80 80zm208 24c13.3.0 24-10.7 24-24s-10.7-24-24-24-24 10.7-24 24 10.7 24 24 24zM248 432c0-13.3-10.7-24-24-24s-24 10.7-24 24 10.7 24 24 24 24-10.7 24-24z"/></svg></span></span><div id=github-53dcb7622c746091d03c6687258787d4-forks class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">0</div></div></div></div><script async type=text/javascript src=/js/fetch-repo.min.dc5533c50cefd50405344b235937142271f26229fe39cbee27fd4960e8bb897a0beebfad77a1091ca91cd0d1fb14e70fc37cc114dd9674fb2c32e0ab512ec8a4.js integrity="sha512-3FUzxQzv1QQFNEsjWTcUInHyYin+OcvuJ/1JYOi7iXoL7r+td6EJHKkc0NH7FOcPw3zBFN2WdPssMuCrUS7IpA==" data-repo-url=https://api.github.com/repos/noetarbouriech/agones-rps-game data-repo-id=github-53dcb7622c746091d03c6687258787d4></script></a></div><h2 class="relative group">Why Agones<div id=why-agones class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#why-agones aria-label=Anchor>#</a></span></h2><p>Before going any further, we need to address a question regarding Agones: <em>Why does it even exist?</em> That was my first reaction upon discovering Agones because, in theory, anyone can just deploy their game server as a regular deployment on a cluster, right? Well, things are actually a bit more complicated than that.</p><p>If you look into the Agones documentation, you will find <a href=https://agones.dev/site/docs/faq/#cant-we-use-a-deployment-or-a-statefulset-for-game-server-workloads target=_blank rel=noreferrer>this section</a> which basically answers the question. To put it simply, game server workloads are <strong>both stateful and stateless</strong>. An empty game server is stateless and can be safely deleted or moved, while a game server with players probably has in-memory state and must not leave the node.</p><p>In other words, Agones allows you to manage and scale game server workloads based not only on CPU, memory, or traffic but also on <strong>player activity</strong>. Thanks to that, you can update game servers without shutting down servers with active players, reuse a game server on which a game has ended or even set autoscaling based on the number of full game servers. And much more.</p><h2 class="relative group">Developing a game server in Go<div id=developing-a-game-server-in-go class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#developing-a-game-server-in-go aria-label=Anchor>#</a></span></h2><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=note><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg></span></div><div class=grow>Note</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>If you don&rsquo;t care about the dev part or if you already have a game server you want to deploy, you can skip to this part: <a href=/posts/making-and-scaling-a-game-server-in-k8s-using-agones/#adding-agones-to-a-game-server>‚Üì Adding Agones to a game server</a></p></div></div><p>To start, we obviously need a game to work with. For this purpose, I will be making a quick and simple game of <strong>rock paper scissors</strong> in Go.</p><p>Since this is just a simple demo, I won&rsquo;t be trying to make something grandiose. It will just be a <strong>basic HTTP server with a WebSocket</strong> on which two players will connect to battle. For a real game, you would probably want to use UDP connections.</p><p>Both players will be connected to the WebSocket and will have to select their move. The connection stays open for both players until they both selected a move. Once both players chose their moves, the server sends the winner to them.</p><p>To do this, I used standard Go packages such as <code>net/http</code> and <code>github.com/gorilla/websocket</code>.</p><div class=highlight-wrapper><div class=codeblock-title>main.go</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=cp>//go:embed index.html</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=kd>var</span><span class=w> </span><span class=nx>index</span><span class=w> </span><span class=nx>embed</span><span class=p>.</span><span class=nx>FS</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=kd>var</span><span class=w> </span><span class=nx>game</span><span class=w> </span><span class=o>*</span><span class=nx>Game</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>	</span><span class=c1>// Inititalize the game</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>	</span><span class=nx>game</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>NewGame</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>	</span><span class=nx>http</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>w</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>		</span><span class=nx>http</span><span class=p>.</span><span class=nf>FileServer</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nf>FS</span><span class=p>(</span><span class=nx>index</span><span class=p>)).</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>	</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>	</span><span class=nx>http</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/ws&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>game</span><span class=p>.</span><span class=nx>ws</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>	</span><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Starting HTTP server on port 3000&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>	</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:3000&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>The root path (<code>/</code>) serves the index.html file (which is <a href=https://pkg.go.dev/embed target=_blank rel=noreferrer>embedded</a> in the binary) and the <code>/ws</code> path serves the WebSocket connection.</p><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=warning><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg></span></div><div class=grow>Warning</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>When making a game server, you should avoid using ports <strong>8080</strong>, <strong>9357</strong> and <strong>9358</strong> in your container image as these will be used by the Agones sidecar container.</p></div></div><p>The index.html is just a very basic web page with buttons for each move (rock, paper, scissors). It uses JavaScript to send a message to the WebSocket when a button is clicked. Results are displayed in the <code>result</code> div.</p><div class=highlight-wrapper><div class=codeblock-title>index.html</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=ln> 1</span><span class=cl><span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>Rock Paper Scissors<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=p>&lt;</span><span class=nt>button</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;send(&#39;rock&#39;)&#34;</span><span class=p>&gt;</span>ü™®<span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=p>&lt;</span><span class=nt>button</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;send(&#39;paper&#39;)&#34;</span><span class=p>&gt;</span>üìÑ<span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=p>&lt;</span><span class=nt>button</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;send(&#39;scissors&#39;)&#34;</span><span class=p>&gt;</span>‚úÇÔ∏è<span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;result&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=kr>const</span> <span class=nx>ws</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebSocket</span><span class=p>(</span><span class=s2>&#34;ws://&#34;</span> <span class=o>+</span> <span class=nx>location</span><span class=p>.</span><span class=nx>host</span> <span class=o>+</span> <span class=s2>&#34;/ws&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=nx>ws</span><span class=p>.</span><span class=nx>onmessage</span> <span class=o>=</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>        <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;result&#34;</span><span class=p>).</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>data</span><span class=p>;</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=kd>function</span> <span class=nx>send</span><span class=p>(</span><span class=nx>choice</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>        <span class=nx>ws</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>choice</span><span class=p>);</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>
</span></span><span class=line><span class=ln>22</span><span class=cl>    <span class=nb>window</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;beforeunload&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>        <span class=nx>ws</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=ln>25</span><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div><p>I won&rsquo;t go too much into details about the game logic since, well, it&rsquo;s just a simple game of rock paper scissors.</p><p>The game loop is fully coded in the WebSocket handler, and it uses methods from the <code>game</code> package located in <code>./internal/game</code>. Here&rsquo;s a basic overview of what this handler does:</p><div class=highlight-wrapper><div class=codeblock-title>main.go</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>s</span><span class=w> </span><span class=o>*</span><span class=nx>Server</span><span class=p>)</span><span class=w> </span><span class=nf>ws</span><span class=p>(</span><span class=nx>w</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>	</span><span class=nx>conn</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>upgrader</span><span class=p>.</span><span class=nf>Upgrade</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w> </span><span class=c1>// Ensure connection is always closed when the handler exits.</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>	</span><span class=c1>// Create a new player based on the connection</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>	</span><span class=nx>player</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>game</span><span class=p>.</span><span class=nf>NewPlayer</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>	</span><span class=nx>s</span><span class=p>.</span><span class=nx>game</span><span class=p>.</span><span class=nf>AddPlayer</span><span class=p>(</span><span class=nx>player</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>	</span><span class=c1>// Read the first message which should contain the player&#39;s move</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>	</span><span class=nx>msgType</span><span class=p>,</span><span class=w> </span><span class=nx>msg</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>conn</span><span class=p>.</span><span class=nf>ReadMessage</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>		</span><span class=c1>// Client disconnected or error occurred</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>		</span><span class=nx>s</span><span class=p>.</span><span class=nx>game</span><span class=p>.</span><span class=nf>RemovePlayer</span><span class=p>(</span><span class=nx>player</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>		</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>	</span><span class=c1>// Play the current player&#39;s move</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>	</span><span class=nx>s</span><span class=p>.</span><span class=nx>game</span><span class=p>.</span><span class=nf>PlayMove</span><span class=p>(</span><span class=nx>player</span><span class=p>,</span><span class=w> </span><span class=nb>string</span><span class=p>(</span><span class=nx>msg</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>	</span><span class=c1>// Check if the two players have played</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>s</span><span class=p>.</span><span class=nx>game</span><span class=p>.</span><span class=nf>Ended</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>		</span><span class=nx>s</span><span class=p>.</span><span class=nx>game</span><span class=p>.</span><span class=nf>SendResults</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>		</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>	</span><span class=c1>// First player gets into a loop waiting for the opponent&#39;s move</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>	</span><span class=nx>player</span><span class=p>.</span><span class=nf>Send</span><span class=p>(</span><span class=s>&#34;Waiting for opponent...\n&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>		</span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>conn</span><span class=p>.</span><span class=nf>ReadMessage</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>			</span><span class=c1>// Client disconnected or error occurred</span><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>			</span><span class=nx>s</span><span class=p>.</span><span class=nx>game</span><span class=p>.</span><span class=nf>RemovePlayer</span><span class=p>(</span><span class=nx>player</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>			</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>If you try to make something similar, keep in mind that you have to handle what happens when a player disconnects or leaves the game. In this case, I just made it so the player gets deleted from the game allowing them or someone else to rejoin. You may want to just end the game or kick everyone else if one of the players disappears.</p><p>In order to manage concurrency, I use a simple <strong>mutex</strong> to ensure that the player list and moves are not modified at the same time. Before every operation, I lock the mutex and unlock it after the operation is complete. For example:</p><div class=highlight-wrapper><div class=codeblock-title>game.go</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Game</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>	</span><span class=nx>players</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>Player</span><span class=w>
</span></span></span><span class="line hl"><span class=ln> 3</span><span class=cl><span class=w>	</span><span class=nx>mu</span><span class=w>      </span><span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>g</span><span class=w> </span><span class=o>*</span><span class=nx>Game</span><span class=p>)</span><span class=w> </span><span class=nf>AddPlayer</span><span class=p>(</span><span class=nx>player</span><span class=w> </span><span class=o>*</span><span class=nx>Player</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>g</span><span class=p>.</span><span class=nx>players</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>player</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>		</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>
</span></span></span><span class="line hl"><span class=ln>13</span><span class=cl><span class=w>	</span><span class=nx>g</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>14</span><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nx>g</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>	</span><span class=nx>g</span><span class=p>.</span><span class=nx>players</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>g</span><span class=p>.</span><span class=nx>players</span><span class=p>,</span><span class=w> </span><span class=nx>player</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>	</span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Player %p added to game&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>player</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>Upon game end, the WebSocket connections are closed and the game server shuts down.</p><p>The end result looks like this:</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=auto alt=Game width=600 height=408 src=/posts/making-and-scaling-a-game-server-in-k8s-using-agones/game.gif srcset="/posts/making-and-scaling-a-game-server-in-k8s-using-agones/game.gif 800w, /posts/making-and-scaling-a-game-server-in-k8s-using-agones/game.gif 1280w" sizes="(min-width: 768px) 50vw, 65vw" data-zoom-src=/posts/making-and-scaling-a-game-server-in-k8s-using-agones/game.gif></figure></p><p>Very impressive, isn&rsquo;t it? Jokes aside, this simple multiplayer game will be more than enough for us to get started with Agones.</p><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=tip><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 384 512"><path fill="currentColor" d="M112.1 454.3c0 6.297 1.816 12.44 5.284 17.69l17.14 25.69c5.25 7.875 17.17 14.28 26.64 14.28h61.67c9.438.0 21.36-6.401 26.61-14.28l17.08-25.68c2.938-4.438 5.348-12.37 5.348-17.7L272 415.1H112L112.1 454.3zM191.4.0132C89.44.3257 16 82.97 16 175.1c0 44.38 16.44 84.84 43.56 115.8 16.53 18.84 42.34 58.23 52.22 91.45.0313.25.0938.5166.125.7823h160.2c.0313-.2656.0938-.5166.125-.7823 9.875-33.22 35.69-72.61 52.22-91.45C351.6 260.8 368 220.4 368 175.1 368 78.61 288.9-.2837 191.4.0132zM192 96.01c-44.13.0-80 35.89-80 79.1.0 9.69-7.2 16.89-16 16.89S80 184.8 80 176c0-61.76 50.25-111.1 112-111.1 8.844.0 16 7.159 16 16S200.8 96.01 192 96.01z"/></svg></span></div><div class=grow>Tip</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>For this quick demo, I made a game server which is running only a single game instance to keep things simple. In our case, it would make more sense to have &ldquo;rooms&rdquo; and be able to host <strong>multiple game instances in a single container</strong>. You can find out more about this in <a href=https://agones.dev/site/docs/integration-patterns/high-density-gameservers/ target=_blank rel=noreferrer>High Density GameServers | Agones</a>.</p></div></div><h2 class="relative group">Adding Agones to a game server<div id=adding-agones-to-a-game-server class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#adding-agones-to-a-game-server aria-label=Anchor>#</a></span></h2><p>Now that we have a game server ready, we need to make some tweaks in order to deploy it with Agones. If you try to deploy it as of right now, it will just crash as Agones expects your container to send regular ping.</p><p>To explain briefly how things work in Agones, when deploying a game server, we use the well named <code>GameServer</code> resource. You can think of GameServers as the equivalent of Pods in the Agones world. They are what will be running your game server container.</p><p>The main difference with regular Pods is that GameServers run your image alongside an <strong>Agones SDK sidecar</strong> which is responsible for managing the lifecycle of the game server. This sidecar is responsible for ensuring that the game server is healthy and available for players. It communicates with the Kubernetes API to update the GameServer resource status.</p><pre class="not-prose mermaid">
---
title: GameServer Architecture
config:
  look: handDrawn
---
graph TD
    KubeAPI["kube-apiserver"]

    subgraph GameServer["GameServer"]
        subgraph Pod["Pod"]
            GameContainer["**Your Game Server** <br>*Container*"]
            AgonesSidecar["**agones-sdk** <br>*Container*"]

            GameContainer <-->|SDK gRPC| AgonesSidecar
        end
    end

    AgonesSidecar -->|HTTP PATCH GameServer resource| KubeAPI
</pre><p>The bare minimum to get your game server up and running with Agones is to implement a <strong>Health Check</strong>. To do this, we first need to import the <a href=https://agones.dev/site/docs/guides/client-sdks/ target=_blank rel=noreferrer>Agones Game Server Client SDK</a>. In my case, I will be importing the <a href=https://pkg.go.dev/agones.dev/agones/pkg/sdk target=_blank rel=noreferrer>Go package</a> but there are also SDKs for other languages such as Java or C++ and also for game engines such as Unity or Unreal Engine.</p><p>Even if your language or game engine doesn&rsquo;t have an SDK, you can still use Agones by making and deploying a sidecar container alongside your game server. This sidecar container would be responsible for communicating with Agones and you would just need to communicate with your game binary. Or else, you can just communicate directly with Agones using the <a href=https://agones.dev/site/docs/reference/grpc/ target=_blank rel=noreferrer>gRPC API</a> or the <a href=https://agones.dev/site/docs/reference/api/ target=_blank rel=noreferrer>HTTP API</a> which should be supported by most languages.</p><p>Once we have our SDK installed, we need to actually implement the health check. This is usually done by creating a loop that sends a ping to Agones every few seconds. Here&rsquo;s how you can do it in Go:</p><div class=highlight-wrapper><div class=codeblock-title>main.go</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>	</span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>	</span><span class=k>go</span><span class=w> </span><span class=nf>HealthPing</span><span class=p>(</span><span class=nx>sdk</span><span class=p>,</span><span class=w> </span><span class=nx>ctx</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>HealthPing</span><span class=p>(</span><span class=nx>sdk</span><span class=w> </span><span class=o>*</span><span class=nx>sdk</span><span class=p>.</span><span class=nx>SDK</span><span class=p>,</span><span class=w> </span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=ln> 7</span><span class=cl><span class=w>	</span><span class=nx>tick</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Tick</span><span class=p>(</span><span class=mi>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span><span class=w>
</span></span></span><span class="line hl"><span class=ln> 8</span><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=ln> 9</span><span class=cl><span class=w>		</span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>sdk</span><span class=p>.</span><span class=nf>Health</span><span class=p>()</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>10</span><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>11</span><span class=cl><span class=w>			</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Could not send health ping, %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>12</span><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>13</span><span class=cl><span class=w>		</span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>14</span><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>15</span><span class=cl><span class=w>			</span><span class=nx>log</span><span class=p>.</span><span class=nf>Print</span><span class=p>(</span><span class=s>&#34;Stopped health pings&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>16</span><span class=cl><span class=w>			</span><span class=k>return</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>17</span><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>tick</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>18</span><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>19</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>Now, we can technically already deploy our game server on a Kubernetes cluster with Agones by creating a <code>GameServer</code> with our game container image. However, we are far from production-ready. We still need to at least implement the following Agones functions:</p><ul><li><strong>Ready()</strong> - To indicate that the game server is ready to accept connections from players.</li><li><strong>Shutdown()</strong> - To tell Agones to shut down the game server.</li></ul><p>Implementing the <code>Ready()</code> function is pretty straightforward. We just need to call it from the SDK when starting the game server:</p><div class=highlight-wrapper><div class=codeblock-title>main.go</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>	</span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>	</span><span class=c1>// Mark server ready </span><span class=w>
</span></span></span><span class="line hl"><span class=ln> 4</span><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>sdk</span><span class=p>.</span><span class=nf>Ready</span><span class=p>();</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=ln> 5</span><span class=cl><span class=w>	    </span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to mark Ready: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class="line hl"><span class=ln> 6</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>	
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>	</span><span class=k>go</span><span class=w> </span><span class=nf>HealthPing</span><span class=p>(</span><span class=nx>sdk</span><span class=p>,</span><span class=w> </span><span class=nx>ctx</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>	
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>	</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:3000&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=p>}</span></span></span></code></pre></div></div><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=info><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg></span></div><div class=grow>Info</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>In theory, you would want your <code>Ready()</code> call to be after your HTTP listener or whatever you&rsquo;re using is fully up and running. In this case, it doesn&rsquo;t really matter as <code>http.ListenAndServe</code> is pretty much instantaneous.</p></div></div><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=tip><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 384 512"><path fill="currentColor" d="M112.1 454.3c0 6.297 1.816 12.44 5.284 17.69l17.14 25.69c5.25 7.875 17.17 14.28 26.64 14.28h61.67c9.438.0 21.36-6.401 26.61-14.28l17.08-25.68c2.938-4.438 5.348-12.37 5.348-17.7L272 415.1H112L112.1 454.3zM191.4.0132C89.44.3257 16 82.97 16 175.1c0 44.38 16.44 84.84 43.56 115.8 16.53 18.84 42.34 58.23 52.22 91.45.0313.25.0938.5166.125.7823h160.2c.0313-.2656.0938-.5166.125-.7823 9.875-33.22 35.69-72.61 52.22-91.45C351.6 260.8 368 220.4 368 175.1 368 78.61 288.9-.2837 191.4.0132zM192 96.01c-44.13.0-80 35.89-80 79.1.0 9.69-7.2 16.89-16 16.89S80 184.8 80 176c0-61.76 50.25-111.1 112-111.1 8.844.0 16 7.159 16 16S200.8 96.01 192 96.01z"/></svg></span></div><div class=grow>Tip</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>If you&rsquo;re used to building apps for Kubernetes, you might have thought about implementing a readiness and a liveness probes. However, here, we don&rsquo;t need those because Agones will manage the game server lifecycle for us.</p></div></div><p>For the <code>Shutdown()</code> function, things are a bit more complicated. What we want to do is to implement a graceful shutdown process. Basically, it means that we need our server to handle signals like <code>SIGTERM</code> <em>politely</em> by waiting for everything to complete before shutting down. It is especially important in order to avoid loss of player data or of an unsaved game for instance.</p><p>Fortunately, this pattern is pretty easy to implement in Go. We will be using the <a href=https://pkg.go.dev/context target=_blank rel=noreferrer>context package</a> to handle cancellation and timeouts coupled with the <a href=https://pkg.go.dev/os/signal target=_blank rel=noreferrer>signal package</a> to handle, as its name implies, signals.</p><p>We are first going to need to create a context that will be used all throughout our server. In order to have it be cancellable with Unix signals, we will be creating it using <code>signal.NotifyContext</code> from the <code>os/signal</code> package. We can then, at the end of our <code>main()</code> function, have all of our code for shutting down our server after <code>&lt;-ctx.Done()</code>.</p><div class=highlight-wrapper><div class=codeblock-title>main.go</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>	</span><span class=c1>// Set up signal handling for graceful shutdown</span><span class=w>
</span></span></span><span class="line hl"><span class=ln> 3</span><span class=cl><span class=w>	</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>cancel</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>signal</span><span class=p>.</span><span class=nf>NotifyContext</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span><span class=w> </span><span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>,</span><span class=w> </span><span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGINT</span><span class=p>)</span><span class=w>
</span></span></span><span class="line hl"><span class=ln> 4</span><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nf>cancel</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>	</span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>	</span><span class=c1>// Initialize HTTP server</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>	</span><span class=nx>httpServer</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>s</span><span class=p>.</span><span class=nf>newHTTPServer</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>	</span><span class=k>go</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Starting HTTP server on port 3000&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>httpServer</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>();</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>ErrServerClosed</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>			</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to start HTTP server: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>	</span><span class=p>}()</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>	</span><span class=c1>// Wait for shutdown signal</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>18</span><span class=cl><span class=w>	</span><span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>	</span><span class=c1>// Shutting down everything</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>	</span><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Shutting down...&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>	</span><span class=nx>s</span><span class=p>.</span><span class=nx>sdk</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>	</span><span class=nx>s</span><span class=p>.</span><span class=nx>game</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>	</span><span class=nx>httpServer</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>Currently, we handle shutdown from signals correctly, but not necessarily gracefully. In general, when implementing this pattern, we want to ensure that all ongoing operations are <strong>completed before shutting down</strong>. In our case, this isn&rsquo;t really important as the process of shutting down the client SDK and the HTTP server should be pretty straightforward.</p><p>However, let&rsquo;s say you&rsquo;re making an actual game: you may want to save the result of your game to a database, for example. In Kubernetes, Pods getting deleted are first sent a <code>SIGTERM</code>, and have a grace period of 30 seconds. After that, Kubernetes sends a <code>SIGKILL</code>, which you want to avoid if possible. If for some reason the database you&rsquo;re sending your data to is experiencing issues, you will want to rollback your transaction before being forcefully terminated.</p><p>We can achieve this by having a timeout, and to do that, we&rsquo;re going to make, once again, a new context, but with <code>context.WithTimeout()</code> this time around. This way, we will be able to pass down the context with timeout to our different shutdown functions and ensure that our game server is properly shut down in a given amount of time.</p><p>In my case, I set it up with a timeout of 10 seconds. This is more than enough for the Agones client SDK and the HTTP server to shut down gracefully.</p><div class=highlight-wrapper><div class=codeblock-title>main.go</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>	</span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>	
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>	</span><span class=c1>// Wait for shutdown signal</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>	</span><span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>	</span><span class=c1>// Create a context with a timeout for graceful shutdown</span><span class=w>
</span></span></span><span class="line hl"><span class=ln> 8</span><span class=cl><span class=w>	</span><span class=nx>shutdownCtx</span><span class=p>,</span><span class=w> </span><span class=nx>cancel</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span><span class=w> </span><span class=mi>10</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span><span class=w>
</span></span></span><span class="line hl"><span class=ln> 9</span><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nf>cancel</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>	</span><span class=c1>// Shutting down everything</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>	</span><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Shutting down...&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>	</span><span class=nx>s</span><span class=p>.</span><span class=nx>sdk</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>	</span><span class=nx>s</span><span class=p>.</span><span class=nx>game</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>	</span><span class=nx>httpServer</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>(</span><span class=nx>shutdownCtx</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=p>}</span></span></span></code></pre></div></div><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=tip><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 384 512"><path fill="currentColor" d="M112.1 454.3c0 6.297 1.816 12.44 5.284 17.69l17.14 25.69c5.25 7.875 17.17 14.28 26.64 14.28h61.67c9.438.0 21.36-6.401 26.61-14.28l17.08-25.68c2.938-4.438 5.348-12.37 5.348-17.7L272 415.1H112L112.1 454.3zM191.4.0132C89.44.3257 16 82.97 16 175.1c0 44.38 16.44 84.84 43.56 115.8 16.53 18.84 42.34 58.23 52.22 91.45.0313.25.0938.5166.125.7823h160.2c.0313-.2656.0938-.5166.125-.7823 9.875-33.22 35.69-72.61 52.22-91.45C351.6 260.8 368 220.4 368 175.1 368 78.61 288.9-.2837 191.4.0132zM192 96.01c-44.13.0-80 35.89-80 79.1.0 9.69-7.2 16.89-16 16.89S80 184.8 80 176c0-61.76 50.25-111.1 112-111.1 8.844.0 16 7.159 16 16S200.8 96.01 192 96.01z"/></svg></span></div><div class=grow>Tip</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>What we just implemented is basically the <a href=https://12factor.net/disposability target=_blank rel=noreferrer>9th factor</a> of the <a href=https://12factor.net/ target=_blank rel=noreferrer>Twelve-Factor App methodology</a> called &ldquo;Disposability&rdquo;. If you don&rsquo;t know about this methodology, I highly recommend you to read it and implement it in your projects.</p></div></div><p>With all of this, we now have the lifecycle of our game server fully implemented and ready to be deployed alongside Agones&rsquo; SDK sidecars in actual <code>GameServer</code> resources.</p><h2 class="relative group">Deploying a game server<div id=deploying-a-game-server class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#deploying-a-game-server aria-label=Anchor>#</a></span></h2><p>Now that we have our game server ready, we can deploy it on a Kubernetes cluster. I&rsquo;m using a basic <a href=https://kind.sigs.k8s.io/ target=_blank rel=noreferrer>kind</a> cluster for this example, but you can use any Kubernetes cluster you want. The only important requirement is to install <a href=https://agones.dev/ target=_blank rel=noreferrer>Agones</a> on your cluster. To do so, you can simply use <a href=https://helm.sh/ target=_blank rel=noreferrer>Helm</a> chart like so:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>helm repo add agones https://agones.dev/chart/stable
</span></span><span class=line><span class=cl>helm repo update
</span></span><span class=line><span class=cl>helm install my-release --namespace agones-system --create-namespace agones/agones</span></span></code></pre></div></div><p>We will be deploying our game server in the <code>default</code> namespace. If you want to deploy yours in a different one, you may need to change some values in your Helm deployment of Agones.</p><p>Once we have our cluster ready with Agones up and running, we can start by deploying our game server image in a simple <a href=https://agones.dev/site/docs/reference/gameserver/ target=_blank rel=noreferrer>GameServer</a> resource:</p><div class=highlight-wrapper><div class=codeblock-title>gameserver.yaml</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>agones.dev/v1</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>GameServer</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rps-game</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>        </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>        </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rps-game</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ghcr.io/noetarbouriech/agones-rps-game/game</span></span></span></code></pre></div></div><p>You should then be able to see it by running <code>kubectl get gameservers</code>. You should see something like this:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>NAME       STATE       ADDRESS        PORT   NODE                           AGE
</span></span><span class=line><span class=cl>rps-game   Ready       192.168.97.2   <span class=m>7278</span>   agones-cluster-control-plane   10s</span></span></code></pre></div></div><p>Notice how Agones picked a <strong>random port between 7000 and 8000</strong> for the game server. This port is exposed on the host node&rsquo;s network using the <a href=https://v1-33.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.33/#containerport-v1-core target=_blank rel=noreferrer>hostPort</a> field of Pods. This means that you can access the game server directly from your host machine using the IP address and port number.</p><p>You can even check its events to see the different steps it went through:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl events --for<span class=o>=</span><span class=s1>&#39;GameServer/rps-game&#39;</span></span></span></code></pre></div></div><p>Which should give you something like this:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>LAST SEEN   TYPE     REASON         OBJECT                            MESSAGE
</span></span><span class=line><span class=cl>3m58s       Normal   Creating       GameServer/rps-game   Pod rps-game created
</span></span><span class=line><span class=cl>3m52s       Normal   Scheduled      GameServer/rps-game   Address and port populated
</span></span><span class=line><span class=cl>3m52s       Normal   RequestReady   GameServer/rps-game   SDK state change
</span></span><span class=line><span class=cl>3m52s       Normal   Ready          GameServer/rps-game   SDK.Ready<span class=o>()</span> complete</span></span></code></pre></div></div><p>You should be able to access the game directly from your web browser by visiting <code>http://ADDRESS:PORT</code>.</p><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=tip><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 384 512"><path fill="currentColor" d="M112.1 454.3c0 6.297 1.816 12.44 5.284 17.69l17.14 25.69c5.25 7.875 17.17 14.28 26.64 14.28h61.67c9.438.0 21.36-6.401 26.61-14.28l17.08-25.68c2.938-4.438 5.348-12.37 5.348-17.7L272 415.1H112L112.1 454.3zM191.4.0132C89.44.3257 16 82.97 16 175.1c0 44.38 16.44 84.84 43.56 115.8 16.53 18.84 42.34 58.23 52.22 91.45.0313.25.0938.5166.125.7823h160.2c.0313-.2656.0938-.5166.125-.7823 9.875-33.22 35.69-72.61 52.22-91.45C351.6 260.8 368 220.4 368 175.1 368 78.61 288.9-.2837 191.4.0132zM192 96.01c-44.13.0-80 35.89-80 79.1.0 9.69-7.2 16.89-16 16.89S80 184.8 80 176c0-61.76 50.25-111.1 112-111.1 8.844.0 16 7.159 16 16S200.8 96.01 192 96.01z"/></svg></span></div><div class=grow>Tip</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>You can use the following to get the host IP and port:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl get gs -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.items[0].status.address}:{.items[0].status.ports[0].port}&#39;</span></span></span></code></pre></div></div></div></div><p>Next, we can deploy the game server in a <a href=https://agones.dev/site/docs/reference/fleets/ target=_blank rel=noreferrer>Fleet</a>. If GameServers are the equivalent of Pods, you can think of Fleets as the equivalent of Deployments or StatefulSets. They allow us to have replicas of our GameServer and scale them up and down without killing active game servers. We can create one just like so:</p><div class=highlight-wrapper><div class=codeblock-title>fleet.yaml</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>agones.dev/v1</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Fleet</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rps-game</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>      </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>          </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>          </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>      </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>        </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>          </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>            </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>rps-game</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>        </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>          </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rps-game</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>              </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ghcr.io/noetarbouriech/agones-rps-game/game</span></span></span></code></pre></div></div><p>We can then check the GameServers it created:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl get gameservers</span></span></code></pre></div></div><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>NAME                   STATE   ADDRESS        PORT   NODE                           AGE
</span></span><span class=line><span class=cl>rps-game-4sxlg-bl6bh   Ready   192.168.97.2   <span class=m>7447</span>   agones-cluster-control-plane   4s
</span></span><span class=line><span class=cl>rps-game-4sxlg-kfmbn   Ready   192.168.97.2   <span class=m>7384</span>   agones-cluster-control-plane   4s
</span></span><span class=line><span class=cl>rps-game-4sxlg-kld5r   Ready   192.168.97.2   <span class=m>7165</span>   agones-cluster-control-plane   4s</span></span></code></pre></div></div><p>This fleet can easily be scaled up by running <code>kubectl scale</code>:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl scale fleet rps-game --replicas<span class=o>=</span><span class=m>5</span></span></span></code></pre></div></div><p>But, right now, if you try to scale it down, it could kill active GameServers. What we want to do in order to avoid that is to use a <a href=https://agones.dev/site/docs/reference/gameserverallocation/ target=_blank rel=noreferrer>GameServerAllocation</a>. This type of resource allows us to set its state from <code>Ready</code> to <code>Allocated</code>, which will prevent Agones from deleting that GameServer. Let&rsquo;s allocate a random GameServer from our fleet with <code>kubectl</code>:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl create -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: allocation.agones.dev/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: GameServerAllocation
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  selectors:
</span></span></span><span class=line><span class=cl><span class=s>    - matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>        agones.dev/fleet: rps-game
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div></div><p>Now, let&rsquo;s do something a bit extreme and scale the fleet down to 0 replicas:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kubectl scale fleet rps-game --replicas<span class=o>=</span><span class=m>0</span></span></span></code></pre></div></div><p>If you look at the list of GameServers, you&rsquo;ll notice that the one we allocated is still there:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>NAME                   STATE       ADDRESS        PORT   NODE                           AGE
</span></span><span class=line><span class=cl>rps-game-4sxlg-bl6bh   Allocated   192.168.97.2   <span class=m>7447</span>   agones-cluster-control-plane   9m40s</span></span></code></pre></div></div><p>This is great, as we managed to scale down without stopping a GameServer that has been marked as being allocated for a game. If you go ahead and finish playing a game on this server, you&rsquo;ll notice that the GameServer gets automatically deleted.</p><p>Of course, in real life, you would probably use the Kubernetes API to allocate our GameServers instead of using kubectl. This way, we can automate the allocation process without manual intervention.</p><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=tip><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 384 512"><path fill="currentColor" d="M112.1 454.3c0 6.297 1.816 12.44 5.284 17.69l17.14 25.69c5.25 7.875 17.17 14.28 26.64 14.28h61.67c9.438.0 21.36-6.401 26.61-14.28l17.08-25.68c2.938-4.438 5.348-12.37 5.348-17.7L272 415.1H112L112.1 454.3zM191.4.0132C89.44.3257 16 82.97 16 175.1c0 44.38 16.44 84.84 43.56 115.8 16.53 18.84 42.34 58.23 52.22 91.45.0313.25.0938.5166.125.7823h160.2c.0313-.2656.0938-.5166.125-.7823 9.875-33.22 35.69-72.61 52.22-91.45C351.6 260.8 368 220.4 368 175.1 368 78.61 288.9-.2837 191.4.0132zM192 96.01c-44.13.0-80 35.89-80 79.1.0 9.69-7.2 16.89-16 16.89S80 184.8 80 176c0-61.76 50.25-111.1 112-111.1 8.844.0 16 7.159 16 16S200.8 96.01 192 96.01z"/></svg></span></div><div class=grow>Tip</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>You might also want to check out the <a href=https://agones.dev/site/docs/advanced/allocator-service/ target=_blank rel=noreferrer>Allocator Service</a> as an alternative way to allocate GameServers from outside our Agones Kubernetes cluster.</p></div></div><h2 class="relative group">Making a matchmaking service<div id=making-a-matchmaking-service class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#making-a-matchmaking-service aria-label=Anchor>#</a></span></h2><p>So far, we managed to make a game server, hook it up to Agones and deploy it on a Kubernetes cluster. All of this is great but it&rsquo;s nothing we couldn&rsquo;t have achieved by simply using regular Kubernetes resources such as Deployments or StatefulSets. But now that we have everything set up, we can actually go a bit further and exploit Agones&rsquo; features to have a <strong>matchmaking service</strong> which will <strong>scale our game servers automatically based on demand üöÄ</strong>.</p><p>Or, at least, that&rsquo;s what we&rsquo;re going to do in the next part of this post. For now, we&rsquo;ll focus on making a matchmaking service that will match 2 players together and will allocate a GameServer to them.</p><p>If you look online, you might find an open-source solution for matchmaking called <a href=https://open-match.dev/ target=_blank rel=noreferrer>Open Match</a>. It has been made by Google, and it can work with Agones, which is great. However, as of writing this, there hasn&rsquo;t been any update in over 2 years. A second version of Open Match called <a href=https://open-match.dev/site/v2/overview/ target=_blank rel=noreferrer>Open Match 2</a> seems to be planned but there are no releases yet and only a single person seems to be working on it.</p><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=note><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg></span></div><div class=grow>Note</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>Just to be clear, I&rsquo;m not saying you should avoid using Open Match, but given the current state of the project, and that it would be overkill for our needs, we&rsquo;ll be making our own simple matchmaking service instead.</p></div></div><p>Here&rsquo;s what we&rsquo;ll be working with:</p><pre class="not-prose mermaid">
---
config:
  look: handDrawn
---
sequenceDiagram
    participant Player as üë§ Player
    participant WebSocketServer as üåê HTTP Server
    participant Topic_matchmaking as üìá Topic: matchmaking
    participant Matcher as ‚öôÔ∏è Matcher
    participant Topic_match_results as üìá Topic: match_results_{playerID}
    participant KubernetesAPI as ‚ò∏Ô∏è Kubernetes API

    Player->>WebSocketServer: Connect via WebSocket
    WebSocketServer->>WebSocketServer: Generate playerID
    WebSocketServer->>Topic_match_results: Subscribe
    WebSocketServer->>Topic_matchmaking: Publish playerID

    Topic_matchmaking->>Matcher: Deliver playerID

    alt No one waiting
        Matcher->>Matcher: Store playerID as waiting
        Note right of Matcher: Wait for next player
    else Another player waiting
        Matcher->>KubernetesAPI: Allocate GameServer
        KubernetesAPI-->>Matcher: GameServer address
        Matcher->>Topic_match_results: Publish match for both players
        Topic_match_results->>WebSocketServer: Deliver match result
        WebSocketServer->>Player: Redirect to match-ip:port
    end
</pre><p>For simplicity‚Äôs sake, I copied the base structure of the game server and reused it in the matchmaking service. This is why we are once again working with an HTTP server serving a WebSocket on <code>/ws</code>. This time, we redirect the player by opening the web page the matchmaking service will return.</p><p>The core component of this matchmaking system is the <strong>Pub/Sub queue</strong>. As you can see on the diagram, we are working with two topics:</p><ul><li><strong>matchmaking</strong>: Player requests for a match.</li><li><strong>match_results_{playerID}</strong>: Topics for the response to the player.</li></ul><p>The brain of the operation is named the <strong>Matcher</strong>, and is basically a process that will take a player from the queue and match them with another one. Once a match is made, it will reserve a GameServer by creating a <code>GameServerAllocation</code> through the Kubernetes API. It then sends them both the server address they need to join via the match results topic of both player.</p><p>To work with Pub/Sub in Go, we&rsquo;ll be using a great library called <a href=https://github.com/ThreeDotsLabs/watermill target=_blank rel=noreferrer>Watermill</a>, which will simplify the task a lot. What&rsquo;s great about this library is that it works with a lot of different options, including Kafka, RabbitMQ or even PostgreSQL. To keep things simple, I chose to go with a simple <a href=https://watermill.io/pubsubs/gochannel/ target=_blank rel=noreferrer>Go Channel</a> which you can also use as a Pub/Sub with Watermill.</p><p>Here&rsquo;s how the WebSocket handler initiates the matchmaking process and waits for a match result with Watermill:</p><div class=highlight-wrapper><div class=codeblock-title>main.go</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>s</span><span class=w> </span><span class=o>*</span><span class=nx>Server</span><span class=p>)</span><span class=w> </span><span class=nf>ws</span><span class=p>(</span><span class=nx>w</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>	</span><span class=nx>conn</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>upgrader</span><span class=p>.</span><span class=nf>Upgrade</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w> </span><span class=c1>// Ensure connection is always closed when the handler exits.</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>	</span><span class=nx>playerID</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>rand</span><span class=p>.</span><span class=nf>Text</span><span class=p>()</span><span class=w> </span><span class=c1>// random player ID</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>	</span><span class=nx>playerResultTopic</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;match_results_%s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>playerID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>	</span><span class=c1>// Publish the matchmaking request</span><span class=w>
</span></span></span><span class="line hl"><span class=ln> 9</span><span class=cl><span class=w>	</span><span class=nx>msg</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>message</span><span class=p>.</span><span class=nf>NewMessage</span><span class=p>(</span><span class=nx>watermill</span><span class=p>.</span><span class=nf>NewUUID</span><span class=p>(),</span><span class=w> </span><span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>playerID</span><span class=p>))</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>10</span><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>s</span><span class=p>.</span><span class=nx>pub</span><span class=p>.</span><span class=nf>Publish</span><span class=p>(</span><span class=s>&#34;matchmaking&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>msg</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to publish matchmaking message: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>		</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>	</span><span class=c1>// Subscribe to the player&#39;s result topic</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>16</span><span class=cl><span class=w>	</span><span class=nx>messages</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>s</span><span class=p>.</span><span class=nx>sub</span><span class=p>.</span><span class=nf>Subscribe</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>playerResultTopic</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to subscribe to player result topic: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>		</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>	</span><span class=c1>// Wait for a match result</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>	</span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>	</span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>s</span><span class=p>.</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=c1>// Exit if the server is shutting down</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>26</span><span class=cl><span class=w>	</span><span class=k>case</span><span class=w> </span><span class=nx>msg</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>messages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>		</span><span class=nx>matchResult</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>string</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Payload</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Match found for player %s: %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>playerID</span><span class=p>,</span><span class=w> </span><span class=nx>matchResult</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>		</span><span class=c1>// Send the match result back to the WebSocket client</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>conn</span><span class=p>.</span><span class=nf>WriteMessage</span><span class=p>(</span><span class=nx>websocket</span><span class=p>.</span><span class=nx>TextMessage</span><span class=p>,</span><span class=w> </span><span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>matchResult</span><span class=p>));</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>			</span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to send match result: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>			</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=w>		</span><span class=c1>// Acknowledge the message and exit</span><span class=w>
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=w>		</span><span class=nx>msg</span><span class=p>.</span><span class=nf>Ack</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=w>		</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>As you can see, it&rsquo;s pretty straightforward with functions such as <code>Subscribe()</code> and <code>Publish()</code>.</p><p>That&rsquo;s basically it for the &ldquo;frontend&rdquo; part of the matchmaking service, but there&rsquo;s a second part which is called the matcher. It runs as a goroutine but it could be run as a separate service if we were to use another Pub/Sub. It&rsquo;s responsible for matching two players from the <code>matchmaking</code> queue.</p><p>To do that, I used a <a href=https://watermill.io/docs/messages-router/ target=_blank rel=noreferrer>Router</a> from Watermill, which gives a lot of features that are pretty nice to build event-driven systems. In our case, I&rsquo;m just using it to add a handler for the <code>matchmaking</code> topic, which can be done just like this:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>router</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>message</span><span class=p>.</span><span class=nf>NewRouter</span><span class=p>(</span><span class=nx>message</span><span class=p>.</span><span class=nx>RouterConfig</span><span class=p>{},</span><span class=w> </span><span class=nx>logger</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nf>AddConsumerHandler</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;matchmaking_handler&#34;</span><span class=p>,</span><span class=w> </span><span class=c1>// Name of the handler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;matchmaking&#34;</span><span class=p>,</span><span class=w>         </span><span class=c1>// Topic to subscribe to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>m</span><span class=p>.</span><span class=nx>sub</span><span class=p>,</span><span class=w>                 </span><span class=c1>// Subscriber</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>m</span><span class=p>.</span><span class=nx>matchmakingHandler</span><span class=p>,</span><span class=w>  </span><span class=c1>// Handler function,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div></div><p>Handler functions in Watermill work like you would expect, by taking a message as input to process it.</p><div class=highlight-wrapper><div class=codeblock-title>matcher.go</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>m</span><span class=w> </span><span class=o>*</span><span class=nx>Matcher</span><span class=p>)</span><span class=w> </span><span class=nf>matchmakingHandler</span><span class=p>(</span><span class=nx>msg</span><span class=w> </span><span class=o>*</span><span class=nx>message</span><span class=p>.</span><span class=nx>Message</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>	</span><span class=c1>// Process the matchmaking message</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>	</span><span class=nx>playerID</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>string</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Payload</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>	</span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Processing player: %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>playerID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>	</span><span class=nx>m</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nx>m</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>
</span></span></span><span class="line hl"><span class=ln> 9</span><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>m</span><span class=p>.</span><span class=nx>waiting</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>10</span><span class=cl><span class=w>		</span><span class=nx>m</span><span class=p>.</span><span class=nx>waiting</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>Player</span><span class=p>(</span><span class=nx>playerID</span><span class=p>)</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>11</span><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>12</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>matchResult</span><span class=w> </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=kt>error</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>	</span><span class=nx>retryInterval</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>19</span><span class=cl><span class=w>		</span><span class=nx>matchResult</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>AllocateGameServer</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>			</span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to allocate game server: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>		</span><span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>retryInterval</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>	</span><span class=nx>resultMsg</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>message</span><span class=p>.</span><span class=nf>NewMessage</span><span class=p>(</span><span class=nx>watermill</span><span class=p>.</span><span class=nf>NewUUID</span><span class=p>(),</span><span class=w> </span><span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>matchResult</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>	</span><span class=c1>// Publish the match result to the player&#39;s topic</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>30</span><span class=cl><span class=w>	</span><span class=nx>playerResultTopic</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;match_results_%s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>playerID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>m</span><span class=p>.</span><span class=nx>pub</span><span class=p>.</span><span class=nf>Publish</span><span class=p>(</span><span class=nx>playerResultTopic</span><span class=p>,</span><span class=w> </span><span class=nx>resultMsg</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to publish match result: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=w>	</span><span class=c1>// Publish the match result to the waiting player&#39;s topic</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>37</span><span class=cl><span class=w>	</span><span class=nx>waitingResultTopic</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;match_results_%s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>m</span><span class=p>.</span><span class=nx>waiting</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>m</span><span class=p>.</span><span class=nx>pub</span><span class=p>.</span><span class=nf>Publish</span><span class=p>(</span><span class=nx>waitingResultTopic</span><span class=p>,</span><span class=w> </span><span class=nx>resultMsg</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to publish match result: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=ln>41</span><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>42</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>43</span><span class=cl><span class=w>	</span><span class=c1>// remove waiting player</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>44</span><span class=cl><span class=w>	</span><span class=nx>m</span><span class=p>.</span><span class=nx>waiting</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>45</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>46</span><span class=cl><span class=w>	</span><span class=c1>// no error</span><span class=w>
</span></span></span><span class=line><span class=ln>47</span><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=ln>48</span><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>What&rsquo;s really important are the parts that are highlighted. You should be able to see the basic matchmaking logic which is to set a player as <em>waiting</em> if no other player is waiting. And when a second player joins, match them together and publish the result to both players.</p><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=note><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg></span></div><div class=grow>Note</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>Notice also how this time I don&rsquo;t use any <code>msg.Ack()</code>. It&rsquo;s because the function is automatically called by Watermill if the handler doesn&rsquo;t return an error.</p></div></div><p>Last but not least, we have to take a look at the <code>AllocateGameServer()</code> function which allocates a random GameServer and returns its IP and port. To do that, I simply use the Kubernetes API to create a resource like we made earlier.</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>allocation</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>v1</span><span class=p>.</span><span class=nx>GameServerAllocation</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>ObjectMeta</span><span class=p>:</span><span class=w> </span><span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>GenerateName</span><span class=p>:</span><span class=w> </span><span class=s>&#34;game-alloc-&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>Namespace</span><span class=p>:</span><span class=w>    </span><span class=s>&#34;default&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Spec</span><span class=p>:</span><span class=w> </span><span class=nx>v1</span><span class=p>.</span><span class=nx>GameServerAllocationSpec</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>Selectors</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=nx>v1</span><span class=p>.</span><span class=nx>GameServerSelector</span><span class=p>{{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>LabelSelector</span><span class=p>:</span><span class=w> </span><span class=nx>metav1</span><span class=p>.</span><span class=nx>LabelSelector</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>MatchLabels</span><span class=p>:</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=s>&#34;agones.dev/fleet&#34;</span><span class=p>:</span><span class=w> </span><span class=s>&#34;rps-game&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>However, if you try deploying the matchmaking service just like that with a Deployment, it will actually not do anything. This is because by default, we are using the <code>default</code> ServiceAccount to access the Kubernetes API from our Pod. To fix this, we just need to create a new <code>ServiceAccount</code> and a <code>RoleBinding</code> that grants the necessary permission to create <code>GameServerAllocation</code> resources.</p><div class=highlight-wrapper><div class=codeblock-title>sa.yaml</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln>1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>matchmaking-sa</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span></span></span></code></pre></div></div><div class=highlight-wrapper><div class=codeblock-title>role.yaml</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln>1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gameserverallocator</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;allocation.agones.dev&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;gameserverallocations&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=ln>9</span><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;create&#34;</span><span class=p>]</span></span></span></code></pre></div></div><div class=highlight-wrapper><div class=codeblock-title>rolebinding.yaml</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RoleBinding</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gameserverallocator-binding</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>matchmaking-sa</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gameserverallocator</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span></span></span></code></pre></div></div><p>And then, we can use this newly created ServiceAccount in our Deployment:</p><div class=highlight-wrapper><div class=codeblock-title>deployment.yaml</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>matchmaking</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>matchmaking</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>matchmaking</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=ln>15</span><span class=cl><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>matchmaking-sa</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>matchmaking</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ghcr.io/noetarbouriech/agones-rps-game/matchmaking</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3000</span></span></span></code></pre></div></div><p>Now, we can just create a Service for this Deployment and access it using port-forwarding like that:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kubectl port-forward service/matchmaking 3000:80</span></span></code></pre></div></div><p>If we access the matchmaking service at <code>localhost:3000</code> and try to play a game, we get this:</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=auto alt=Matchmaking width=800 height=454 src=/posts/making-and-scaling-a-game-server-in-k8s-using-agones/matchmaking.gif srcset="/posts/making-and-scaling-a-game-server-in-k8s-using-agones/matchmaking.gif 800w, /posts/making-and-scaling-a-game-server-in-k8s-using-agones/matchmaking.gif 1280w" sizes="(min-width: 768px) 50vw, 65vw" data-zoom-src=/posts/making-and-scaling-a-game-server-in-k8s-using-agones/matchmaking.gif></figure></p><p>As you can see from the screen briefly flashing to black, the matchmaking service indeed redirects to a game server once a match is found.</p><p>Something to keep in mind is that in its current state, the matchmaking is not scalable. You can&rsquo;t really run multiple instances of the matchmaking as you could end up with players stuck in different matcher&rsquo;s instances.</p><p>However, it shouldn&rsquo;t really matter as you can shard the matchmaking service by region (eu, us, etc.) or skill-level (<a href=https://en.wikipedia.org/wiki/Elo_rating_system target=_blank rel=noreferrer>Elo</a>, rank). Then, you can have an instance of the matchmaking service for each shard. For example, you could have an instance running only on <code>eu.elo100-200.matchmaking</code> and one on <code>us.elo100-200.matchmaking</code>.</p><p>Also, I used a WebSocket again because I shamelessly copy-pasted the code from the game server as the base for the matchmaking service. However, you would be better off using an HTTP API where you issue a ticket and poll the match result. Or, maybe even <a href=https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events target=_blank rel=noreferrer>SSE</a>?</p><h2 class="relative group">Setting up autoscaling of game servers<div id=setting-up-autoscaling-of-game-servers class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#setting-up-autoscaling-of-game-servers aria-label=Anchor>#</a></span></h2><p>Everything works pretty well so far, right? Well, there&rsquo;s still a problem that remains to be solved. If you&rsquo;ve followed along until now, so far we have a game running on Agones. There are multiple instances and a matchmaking service that routes each player to one of them. However, if we have 6 players all playing at the same time, we&rsquo;ll end up with our 3 games instances being allocated, making it impossible for the matchmaking service to find a game for any new players.</p><p>To solve this issue, we have to set up <strong>autoscaling</strong> for our fleet of game servers. To do that, we need to create a <a href=https://agones.dev/site/docs/reference/fleetautoscaler/ target=_blank rel=noreferrer>FleetAutoscaler</a>:</p><div class=highlight-wrapper><div class=codeblock-title>fleetautoscaler.yaml</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;autoscaling.agones.dev/v1&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>FleetAutoscaler</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rps-game-autoscaler</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>  </span><span class=nt>fleetName</span><span class=p>:</span><span class=w> </span><span class=l>rps-game</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>  </span><span class=nt>policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>    </span><span class=c># type of the policy</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Buffer</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>    </span><span class=nt>buffer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>      </span><span class=c># Size of a buffer of &#34;ready&#34; game server instances</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>      </span><span class=nt>bufferSize</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>      </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>  </span><span class=nt>sync</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>FixedInterval</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>    </span><span class=nt>fixedInterval</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>      </span><span class=c># the time in seconds between each auto scaling</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>      </span><span class=nt>seconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span></span></span></code></pre></div></div><p>I set it up with a <strong><a href=https://agones.dev/site/docs/reference/fleetautoscaler/#ready-buffer-autoscaling target=_blank rel=noreferrer>buffer policy</a></strong> which ensures that there&rsquo;s always a buffer of ready game servers available. In this case, I set it to 10 instances which are checked every 5 seconds.</p><p>There are other policies which are also interesting to look at such as:</p><ul><li>The <a href=https://agones.dev/site/docs/reference/fleetautoscaler/#counter-and-list-autoscaling target=_blank rel=noreferrer>counter policy</a> which scales based on a GameServer counter. It can be useful if you set up multiple rooms in a single game instance like I mentioned earlier.</li><li>The <a href=https://agones.dev/site/docs/reference/fleetautoscaler/#webhook-autoscaling target=_blank rel=noreferrer>webhook policy</a> which allows us to scale based on a custom logic we can implement as a webhook handler. We can, for instance, scale it based on the number of players waiting in the matchmaking system.</li><li>The <a href=https://agones.dev/site/docs/reference/fleetautoscaler/#wasm-autoscaling target=_blank rel=noreferrer>WASM policy</a> which as its name implies, allows us to scale based on a custom logic using WebAssembly modules. I have yet to find a use case for it, but it&rsquo;s definitely interesting to explore.</li><li>The <a href=https://agones.dev/site/docs/reference/fleetautoscaler/#schedule-and-chain-autoscaling target=_blank rel=noreferrer>Schedule policy</a> which is pretty neat as it allows us to set a policy for a specific time period. It can be useful to scale up during an event or for the release of a game, for example.</li></ul><p>For simplicity‚Äôs sake, we&rsquo;ll continue with the buffer policy as it works decently well if we set the sync interval to a low value.</p><p>Now, for the fun part, let&rsquo;s put this autoscaling to the test!</p><p>There&rsquo;s a tool called <a href=https://k6.io/ target=_blank rel=noreferrer>k6</a> which is a load testing tool made by Grafana that can be used to simulate a large number of users connecting to our game server. We can use it to test our autoscaling policy and see how it performs under load. It simulates users with a custom script that can be written in JavaScript.</p><p>Here&rsquo;s the one I made for this project:</p><div class=highlight-wrapper><div class=codeblock-title>script.js</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln> 1</span><span class=cl><span class=kr>import</span> <span class=nx>ws</span> <span class=nx>from</span> <span class=s2>&#34;k6/ws&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=kr>import</span> <span class=nx>http</span> <span class=nx>from</span> <span class=s2>&#34;k6/http&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>check</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;k6&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=nx>vus</span><span class=o>:</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nx>__ENV</span><span class=p>.</span><span class=nx>K6_VUS</span><span class=p>)</span> <span class=o>||</span> <span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>  <span class=nx>duration</span><span class=o>:</span> <span class=nx>__ENV</span><span class=p>.</span><span class=nx>K6_DURATION</span> <span class=o>||</span> <span class=s2>&#34;20s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>  <span class=kr>const</span> <span class=nx>wsURL</span> <span class=o>=</span> <span class=s2>&#34;ws://localhost:3000/ws&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>
</span></span><span class=line><span class=ln>13</span><span class=cl>  <span class=kr>const</span> <span class=nx>params</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>tags</span><span class=o>:</span> <span class=p>{</span> <span class=nx>test</span><span class=o>:</span> <span class=s2>&#34;websocket-match&#34;</span> <span class=p>}</span> <span class=p>};</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>
</span></span><span class=line><span class=ln>15</span><span class=cl>  <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>connect</span><span class=p>(</span><span class=nx>wsURL</span><span class=p>,</span> <span class=nx>params</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>socket</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s2>&#34;open&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=nx>open</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Connected to matchmaking&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>
</span></span><span class=line><span class=ln>20</span><span class=cl>    <span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=nx>message</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>      <span class=kr>const</span> <span class=nx>matchURL</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>toString</span><span class=p>().</span><span class=nx>trim</span><span class=p>();</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Received match URL: </span><span class=si>${</span><span class=nx>matchURL</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>
</span></span><span class=line><span class=ln>24</span><span class=cl>      <span class=c1>// Make HTTP GET request to the match URL
</span></span></span><span class=line><span class=ln>25</span><span class=cl>      <span class=kr>const</span> <span class=nx>httpRes</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>matchURL</span><span class=p>);</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>
</span></span><span class=line><span class=ln>27</span><span class=cl>      <span class=c1>// Check if the HTTP request was successful
</span></span></span><span class=line><span class=ln>28</span><span class=cl>      <span class=nx>check</span><span class=p>(</span><span class=nx>httpRes</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>        <span class=s2>&#34;match URL status is 200&#34;</span><span class=o>:</span> <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>
</span></span><span class=line><span class=ln>32</span><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`HTTP Response status: </span><span class=si>${</span><span class=nx>httpRes</span><span class=p>.</span><span class=nx>status</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=ln>33</span><span class=cl>
</span></span><span class=line><span class=ln>34</span><span class=cl>      <span class=nx>socket</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span></span><span class=line><span class=ln>35</span><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=ln>36</span><span class=cl>
</span></span><span class=line><span class=ln>37</span><span class=cl>    <span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s2>&#34;close&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=nx>close</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>38</span><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;WebSocket disconnected&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>39</span><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=ln>40</span><span class=cl>
</span></span><span class=line><span class=ln>41</span><span class=cl>    <span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s2>&#34;error&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>42</span><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;WebSocket error:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=ln>43</span><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=ln>44</span><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=ln>45</span><span class=cl>
</span></span><span class=line><span class=ln>46</span><span class=cl>  <span class=c1>// Check WebSocket connection status
</span></span></span><span class=line><span class=ln>47</span><span class=cl>  <span class=nx>check</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>48</span><span class=cl>    <span class=s2>&#34;websocket status is 101&#34;</span><span class=o>:</span> <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span> <span class=o>&amp;&amp;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>101</span><span class=p>,</span>
</span></span><span class=line><span class=ln>49</span><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=ln>50</span><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>As you can see, this script <del>that is definitely not AI-generated</del> opens the WebSocket connection with the matchmaking service and just sends a GET request to the game server.</p><p>We&rsquo;ll be running this script in k6 with 100 virtual users for a duration of 30 seconds.</p><p>And here&rsquo;s the result:</p><script src=https://asciinema.org/a/FqXZQp1OryIG6NKZ.js id=asciicast-FqXZQp1OryIG6NKZ async></script><details class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm group" data-type=success><summary class="flex items-center gap-2 font-semibold text-inherit cursor-pointer"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M438.6 105.4c12.5 12.5 12.5 32.7.0 45.2l-256 256c-12.5 12.5-32.7 12.5-45.2.0L9.372 278.6c-12.496-12.5-12.496-32.7.0-45.2 12.498-12.5 32.758-12.5 45.258.0L159.1 338.7 393.4 105.4c12.5-12.52 32.7-12.52 45.2.0h0z"/></svg></span></div><div class=grow>k6 output logs</div><div class="ms-auto flex h-5 w-5 items-center justify-center transition-transform ease-in-out -rotate-90 group-open:rotate-0 print:hidden"><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></div></summary><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>  ‚ñà TOTAL RESULTS
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    checks_total.......: 220     4.398727/s
</span></span><span class=line><span class=cl>    checks_succeeded...: 100.00% 220 out of 220
</span></span><span class=line><span class=cl>    checks_failed......: 0.00%   0 out of 220
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ‚úì match URL status is 200
</span></span><span class=line><span class=cl>    ‚úì websocket status is 101
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    HTTP
</span></span><span class=line><span class=cl>    http_req_duration..............: avg=1.44ms  min=354.87¬µs med=1.31ms  max=5.49ms  p(90)=2.14ms  p(95)=2.54ms
</span></span><span class=line><span class=cl>      { expected_response:true }...: avg=1.44ms  min=354.87¬µs med=1.31ms  max=5.49ms  p(90)=2.14ms  p(95)=2.54ms
</span></span><span class=line><span class=cl>    http_req_failed................: 0.00%  0 out of 110
</span></span><span class=line><span class=cl>    http_reqs......................: 110    2.199363/s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    EXECUTION
</span></span><span class=line><span class=cl>    iteration_duration.............: avg=23.13s  min=106.02ms med=24.19s  max=46.16s  p(90)=45.77s  p(95)=46.14s
</span></span><span class=line><span class=cl>    iterations.....................: 110    2.199363/s
</span></span><span class=line><span class=cl>    vus............................: 40     min=40       max=100
</span></span><span class=line><span class=cl>    vus_max........................: 100    min=100      max=100
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    NETWORK
</span></span><span class=line><span class=cl>    data_received..................: 170 kB 3.4 kB/s
</span></span><span class=line><span class=cl>    data_sent......................: 37 kB  739 B/s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    WEBSOCKET
</span></span><span class=line><span class=cl>    ws_connecting..................: avg=26.93ms min=3.49ms   med=35.46ms max=44.52ms p(90)=41.99ms p(95)=42.34ms
</span></span><span class=line><span class=cl>    ws_msgs_received...............: 110    2.199363/s
</span></span><span class=line><span class=cl>    ws_session_duration............: avg=23.13s  min=105.98ms med=24.19s  max=46.16s  p(90)=45.77s  p(95)=46.14s
</span></span><span class=line><span class=cl>    ws_sessions....................: 150    2.999132/s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>running (50.0s), 000/100 VUs, 110 complete and 40 interrupted iterations
</span></span><span class=line><span class=cl>default ‚úì [ 100% ] 100 VUs  20s</span></span></code></pre></div></div></div></details><p>As you can see, the autoscaler has a hard time keeping up with the load. To avoid that, we can increase the buffer size and decrease the sync interval. Or even better, switch to the webhook policy and implement a webhook endpoint which exposes the number of players currently waiting for a game server allocation.</p><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=tip><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 384 512"><path fill="currentColor" d="M112.1 454.3c0 6.297 1.816 12.44 5.284 17.69l17.14 25.69c5.25 7.875 17.17 14.28 26.64 14.28h61.67c9.438.0 21.36-6.401 26.61-14.28l17.08-25.68c2.938-4.438 5.348-12.37 5.348-17.7L272 415.1H112L112.1 454.3zM191.4.0132C89.44.3257 16 82.97 16 175.1c0 44.38 16.44 84.84 43.56 115.8 16.53 18.84 42.34 58.23 52.22 91.45.0313.25.0938.5166.125.7823h160.2c.0313-.2656.0938-.5166.125-.7823 9.875-33.22 35.69-72.61 52.22-91.45C351.6 260.8 368 220.4 368 175.1 368 78.61 288.9-.2837 191.4.0132zM192 96.01c-44.13.0-80 35.89-80 79.1.0 9.69-7.2 16.89-16 16.89S80 184.8 80 176c0-61.76 50.25-111.1 112-111.1 8.844.0 16 7.159 16 16S200.8 96.01 192 96.01z"/></svg></span></div><div class=grow>Tip</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>The next step would be to improve the script to include actual game inputs with the game servers. With this, we could even imagine running a kind cluster with Agones and our game and k6 as part of CI tests.</p></div></div><h2 class="relative group">Conclusion<div id=conclusion class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#conclusion aria-label=Anchor>#</a></span></h2><p>This little experiment with Agones took longer than I first expected it to be, but I learned a lot and had quite some fun. Overall, I would say that Agones is very interesting in the way it transforms how we work with Kubernetes.</p><p>I think making a game and a matchmaking system from scratch to work with Agones really helped me understand better how concepts would work together. I understood so much more about Agones doing it this way than I did at first when going through the documentation.</p><p>Still, there are many things I haven&rsquo;t tried, such as the other autoscaling policies, using counters and lists, or just working with an actual game server with real-time communication in UDP. There are also related projects such as <a href=https://github.com/embarkstudios/quilkin target=_blank rel=noreferrer>Quilkin</a> which is a UDP proxy that can be used to route traffic to game servers and seems to work well with Agones.</p><p>I hope this article has been helpful for you and that you have learned something new about Agones and Kubernetes. I would appreciate any feedback you might have on this article. Thank you for reading!</p></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_posts/making-and-scaling-a-game-server-in-k8s-using-agones/index.md data-oid-likes=likes_posts/making-and-scaling-a-game-server-in-k8s-using-agones/index.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/posts/hello-world/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;Hello World
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=1970-01-01T00:00:00+00:00>1 January 1970</time>
</span></span><span class="flex flex-col items-end"></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><div class=giscus><script>function getGiscusTheme(){const e=localStorage.getItem("appearance"),t=e==null||e=="light"?"light_protanopia":"dark_protanopia";return t}function setGiscusTheme(){function e(e){const t=document.querySelector("iframe.giscus-frame");if(!t)return;t.contentWindow.postMessage({giscus:e},"https://giscus.app")}e({setConfig:{theme:getGiscusTheme()=="light_protanopia"?"dark_protanopia":"light_protanopia"}})}const attrs={src:"https://giscus.app/client.js","data-repo":"noetarbouriech/noe-t.dev","data-repo-id":"R_kgDON-S0OA","data-category":"Announcements","data-category-id":"DIC_kwDON-S0OM4CnQE4","data-mapping":"title","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getGiscusTheme(),"data-lang":"en",crossorigin:"anonymous","data-loading":"lazy",async:""},giscusScript=document.createElement("script");Object.entries(attrs).forEach(([e,t])=>giscusScript.setAttribute(e,t)),document.body.appendChild(giscusScript);const toggle=document.querySelector("#appearance-switcher");toggle&&toggle.addEventListener("click",setGiscusTheme)</script><noscript>Please enable JavaScript to view the comments</noscript></div></div></div></footer></article><div id=scroll-to-top class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2026
No√© Tarbouriech</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://noe-t.dev/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>